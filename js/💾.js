let filename="sequence",extension=".ðŸ—¿";function enableNewSaving(){sexySaving=!0,$("#saveAsText").text("Save As"),$("#saveBtn").show()}function disableNewSaving(){sexySaving=!1,$("#saveAsText").text("Save"),$("#saveBtn").hide()}let sexySavingSupported="function"==typeof window.showSaveFilePicker,sexySaving=!settings.oldSaving&&sexySavingSupported;function generateSequenceFile(){let e=Date.now();console.log(`Exporting sequence... (${$("#sequence div").length} icons)`);let n=[],t="";$("#sequence div").each((function(){let e=$(this);if(e.attr("sound")){let n=e.attr("str"),a=e.attr("pitch"),i=e.attr("vol"),o=soundList.find((e=>e.id==n)),l=o?o.emoji||o.id:n||"_pause",s=a&&0!=a;t=s?`${l}@${a}`:l,i&&100!=i&&(t+=`${s?"":"@0"}%${i}`)}else if(e.attr("action")){let n=e.attr("action"),a="!"+n;if("divider"==n)a+="\n";else if(e.attr("advanced"))a+=`@${e.attr("val1")},${e.attr("val2")}`;else if(e.attr("amount")){let n=e.attr("num");a+="@"+Number(e.attr("amount")),a+="add"==n?"@+":"multiply"==n?"@x":""}t=a}n.length&&n[n.length-1][0]==t?n[n.length-1][1]++:n.push([t,1])}));let a=n.map((e=>`${e[0]}${e[1]>1?"="+e[1]:""}`)).join("|");return console.log(`Exporting took ${+((Date.now()-e)/1e3).toFixed(2)}s`),a}function classicSave(e){if(!generateSequenceFile().length)return;let n=document.createElement("a");n.href=URL.createObjectURL(e),n.dataset.downloadurl=["text/txt",n.download,n.href].join(":"),n.style.display="none",n.download=filename+extension,n.target="_blank",document.body.appendChild(n),n.click(),document.body.removeChild(n),setUnsavedChanges(!1),$("#saveBtn").addClass("alreadySaved")}function modernSave(e){window.showSaveFilePicker({suggestedName:filename+extension}).then((n=>{n.createWritable().then((t=>{setSaveLocation(n),setUnsavedChanges(!1),t.write(e).then((()=>t.close())).catch(console.error)})).catch(console.error)})).catch(console.error)}function setFilename(e){filename=e,filename.endsWith(extension)&&(filename=filename.slice(0,-1*extension.length)),$("#saveName").val(filename)}sexySaving?enableNewSaving():disableNewSaving(),$("#saveOptions").show(),sexySavingSupported&&$(".requiresNewSaving").show(),$("#downloadBtn").click((function(){let e=generateSequenceFile();if(!e.length)return;let n=new Blob([e],{type:"text/txt;charset=UTF-8"});return ctrlHeld&&altHeld?openSequencePreview(n):sexySaving?modernSave(n):classicSave(n)}));let saveLocation=null;function setSaveLocation(e){setFilename(e.name),saveLocation=e}function quickSave(){if(!saveLocation||saveLocation.name!=filename+extension)return $("#downloadBtn").trigger("click");let e=generateSequenceFile();return e.length?ctrlHeld&&altHeld?openSequencePreview(new Blob([e],{type:"text/txt;charset=UTF-8"})):void saveLocation.createWritable().then((async n=>{n.write(e).then((()=>{setUnsavedChanges(!1),n.close()})).catch((e=>alert(e)))})).catch((()=>{})):void 0}function openSequencePreview(e){let n=URL.createObjectURL(e);window.open(n)}let reader=new FileReader;function readLoadedFile(e){e&&($("#sequence").html(""),$("#loadFile").val(""),reader.readAsText(e),reader.onload=function(n){loadSequence(n.target.result),saveLocation=null,setFilename(e.name)})}function loadSequence(e){let n=Date.now();console.log(`Loading sequence... (size: ${+(e.length/1e3).toFixed(2)} KB)`);try{let t="";(e||"").replace(/\s/g,"").split("|").forEach((e=>{let[n,a]=e.split("="),[i,o,l]=n.split("@");if(!i||!n)return;let s=null;if(i.startsWith("!")){if(i=i.slice(1),s=$(`.action[action=${i}]`).first().clone(),!s.length)return;let e=actions.find((e=>e.name==i));if(e.twoValues){s.find("p").length||s.append("<p></p>");for(let n=0;n<(a||1);n++)t+=addAdvancedAction(e.name,o.split(","),s,!0).prop("outerHTML");return}if(e.amount||e.isTarget){e.isTarget&&!o&&(o=1),s.find("p").length||s.append("<p></p>"),"x"==l?l="multiply":"+"==l&&(l="add");for(let e=0;e<(a||1);e++)t+=addAction(i,+o,l,s,!0).prop("outerHTML");return}}else{i.includes("%")&&([i,o]=i.split("%"),o="%"+o);let[e,n]=(o||"").split("%").map((e=>+e)),t=soundList.find((e=>"_pause"!=e.id&&(e.id==i||e.emoji==i)));s=$(`.sound[str=${t?t.id:"_pause"}]`).first().clone(),t&&(e&&(s.attr("pitch",e),s.append(`<p>${e>0?"+":""}${e}</p>`)),(n||0===n)&&(s.attr("vol",n),s.append(`<vol>${n}%</vol>`))),s.removeAttr("soundorigin"),s.removeAttr("soundname")}if(s)for(let e=0;e<(a||1);e++)t+=s[0].outerHTML})),$("#sequence")[0].innerHTML=t,deselectSection(),syncSections(),fetchRequiredSounds(),setUnsavedChanges(!1),cancel(),console.log(`Loading took ${+((Date.now()-n)/1e3).toFixed(2)}s`)}catch(e){alert("That file couldn't be loaded!"),console.warn(e)}}function safeFilename(e){return e.replace(/[/\\:*?"<>|]/g,"")}function setUnsavedChanges(e){unsavedChanges=!!e,unsavedChanges?$("#saveBtn").removeClass("alreadySaved"):$("#saveBtn").addClass("alreadySaved")}$("#loadFile").on("change",(function(){readLoadedFile(this.files[0])})),$("#saveName").on("input keydown keyup blur",(function(){let e=safeFilename($(this).val());filename=e||"sequence",$(this).val(e)})),$("body").on("dragover dragenter",(function(e){return e.preventDefault(),e.stopPropagation(),!active&&e.originalEvent.dataTransfer.types.includes("Files")&&$("body").addClass("dragOver"),!1})),$("body").on("dragleave dragend drop",(function(e){return e.preventDefault(),e.stopPropagation(),$("body").removeClass("dragOver"),!1})),$("body").on("drop",(function(e){if(active)return!1;if(e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length){if(e.preventDefault(),e.stopPropagation(),unsavedChanges&&$("#sequence").children().length&&!confirm("Are you sure you want to load this file? Any unsaved changes will be lost."))return;readLoadedFile(e.originalEvent.dataTransfer.files[0])}}));let unsavedChanges=!1;$("#sequence").on("DOMSubtreeModified",(function(){setUnsavedChanges(!0)})),window.onbeforeunload=function(e){if(unsavedChanges&&$("#sequence").children().length&&settings.exitConfirmation)return e.returnValue="ðŸ—¿",cancel()};