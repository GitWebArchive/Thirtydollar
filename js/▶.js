let MAX_BPM_LIMIT=2e4;function getSequenceData(){return $("#sequence div").map((function(e){return{index:e,element:$(this),sound:$(this).attr("sound"),pitch:$(this).attr("pitch"),volume:$(this).attr("vol"),action:$(this).attr("action"),icon:$(this).attr("img"),group:+$(this).parent().attr("group")||0,amount:$(this).attr("amount"),operator:$(this).attr("num"),dualVal:[$(this).attr("val1"),$(this).attr("val2")]}})).toArray()}function beatLength(e){return 60/e*1e3}function modifyNumber(e,t,n){switch(n){case"add":return e+t;case"multiply":return e*t;default:return t}}async function fetchRequiredSounds(e=getSequenceData()){let t=Object.keys(sounds);for(let n=0;n<e.length;n++){let i=e[n];i.sound&&"sounds/_pause.wav"!=i.sound&&!t.includes(i.sound)&&(await fetchSound(i.sound),t.push(i.sound))}}function preloadSequence(e=getSequenceData()){let t=[],n=defaultTempo,i=defaultVolume,a=0,o=0,u=0,r=0,s=0,l=0,c=e.filter((e=>!("startpos"!=e.action||selectedDivider>=0&&e.group!=selectedDivider)));c.length?s=c[c.length-1].index:selectedDivider>=0&&(s=(e.find((e=>e.group==selectedDivider))||{}).index||0);let m=s>0;function d(t,n=[]){let i=[];return e.slice(t+1).map(((e,a)=>(n.includes(e.action)||(e.triggered&&(e.triggered=!1,i.push(t+1+a)),e.remaining<=0&&(delete e.remaining,i.push(t+1+a))),e))),i}for(;u<e.length;){let c=e[u],g=!1;if(m&&u==s&&(m=!1),c.sound){let n=isNaN(+c.volume)?100:+c.volume,a={index:u,sound:c.sound,volume:i*clamp(n/100,0,4),pitch:clamp((+c.pitch||0)+o,-72,72),time:r/1e3,element:c.element,img:c.element.find("img")};"combine"!=(e[u+1]||{}).action&&(g=!0),m||t.push(a)}else if(c.action){let s=Number(c.amount)||0,g={index:u,action:c.action,pulse:!0,trigger:!0,scrub:m,time:r/1e3,element:c.element,img:c.element.find("img")};switch(c.action){case"speed":n=modifyNumber(n,s,c.operator),n=Number(clamp(n,5,MAX_BPM_LIMIT).toFixed(4)),g.bpm=n;break;case"volume":i=modifyNumber(i,s,c.operator),i=Number(clamp(i,0,600).toFixed(4)),g.volume=i;break;case"stop":let p=isNaN(c.remaining)?s:c.remaining;if(!m&&p>0){let t=Math.min(1,p);r+=beatLength(n)*t,p-=1,p<0&&(p=0),g.remaining=p,e[u].remaining=p,u--,g.trigger=!1}else g.finished=!0,g.duration=s;break;case"loopmany":let f=isNaN(c.remaining)?s:c.remaining;!m&&f>0?(f--,g.remaining=f,e[u].remaining=f,u=a-1,f<1?g.pulse=!1:g.trigger=!1,g.untriggered=d(u,["loopmany"])):g.skip=!0;break;case"loop":c.triggered?g.skip=!0:(e[u].triggered=!0,u=a-1,g.untriggered=d(u,["loop","loopmany"]));break;case"looptarget":a=u;break;case"cut":case"startpos":case"flash":break;case"combine":m&&(g.skip=!0);break;case"jump":if(c.triggered)g.skip=!0;else{let t=e.findIndex((e=>"target"==e.action&&!e.triggered&&e.amount==c.amount));t>=0&&(e[u].triggered=!0,g.target=t,u=t),g.untriggered=d(u,["loop","loopmany","jump","target"])}break;case"target":g.trigger=!1,g.pulse=!1;break;case"transpose":o=modifyNumber(o,s,c.operator),o=Number(clamp(o,-60,60).toFixed(4));break;case"pulse":if(m)g.skip=!0;else{if(g.count=Math.floor(clamp(+c.dualVal[0],0,1e3)),g.frequency=clamp(Number(c.dualVal[1]).toFixed(4),0,1e3),g.trigger=!1,g.pulseID=l,g.frequency||(g.skip=!0),g.count>1&&g.frequency>0){for(let e=1;e<g.count;e++){let i=r+beatLength(n)*g.frequency*e;t.find((e=>e.action==c.action&&e.time==i))||t.push({index:u,action:c.action,pulse:!0,pulseID:l,trigger:e==g.count-1,time:i/1e3,element:c.element,img:g.img})}l++}else g.trigger=!0;g.count<1&&(g.stopPulses=!0)}break;case"bg":g.bgColor=c.dualVal[0].match(colorRegex)?c.dualVal[0]:defaultBG,g.fadeTime=m?.1:clamp(Number(c.dualVal[1]).toFixed(4),0,200)}g.skip||t.push(g)}u++,!m&&g&&(r+=beatLength(n))}return t.sort(((e,t)=>e.time-t.time))}let lastPos=-200,lastPulse=0,startTime=0,playingSequence=[],nextSoundToQueue=0,nextAction=0;function playSequence(e){updateTempo(defaultTempo),setVolume(defaultVolume),lastPulse=0,startTime=soundcloud.currentTime,playingSequence=e,nextSoundToQueue=0,nextAction=0,queueSounds(),checkActions()}const queueAhead=5;function queueSounds(){for(;nextSoundToQueue<playingSequence.length;nextSoundToQueue++){let e=playingSequence[nextSoundToQueue];if(startTime+e.time>soundcloud.currentTime+queueAhead)break;if("cut"===e.action)cutSounds(startTime+e.time);else if(void 0!==e.sound){let t=semitonesToPercent(clamp(e.pitch,-72,72));playSound(e.sound,{pitch:t,playAt:startTime+e.time,index:e.index,volume:e.volume/200})}}nextSoundToQueue<playingSequence.length&&setTimeout(queueSounds,1e3)}function checkActions(){if(active){for(;nextAction<playingSequence.length;nextAction++){let e=playingSequence[nextAction];if(startTime+e.time>soundcloud.currentTime)break;if(e.triggered)continue;e.triggered=!0;let t=e.element,n=e.img;if(e.sound)t.runAnimation("bounce");else if(e.action&&!settings.noAnimations)switch(e.pulse&&t.runAnimation("pulse"),e.trigger&&n.runAnimation("triggered"),e.untriggered&&e.untriggered.length&&e.untriggered.forEach((e=>{$("#sequence div").eq(e).find("img").removeClass("triggered")})),e.action){case"speed":updateTempo(e.bpm);break;case"volume":setVolume(e.volume);break;case"stop":let n=t.find("p");n.attr("triggeredCountdown",!0),e.finished?n.text(e.duration):n.text(e.remaining+1);break;case"loopmany":let i=t.find("p");i.attr("triggeredCountdown",!0),e.remaining<=0?i.text(""):i.text(e.remaining);break;case"jump":let a=$("#sequence div").eq(e.target);a.runAnimation("pulse"),a.find("img").runAnimation("triggered");break;case"flash":e.scrub||$("#everything").runAnimation("screenflash");break;case"pulse":e.pulseID>lastPulse&&(lastPulse=e.pulseID),e.scrub||e.stopPulses||lastPulse!=e.pulseID||$("body").runAnimation("screenpulse");break;case"bg":e.ignore||$("html").css("transition-duration",e.fadeTime+"s").css("background-color",e.bgColor)}if(settings.autoScroll){let n=600,i=t.prop("offsetTop")-150;Math.abs(i-lastPos)>n&&($("#everything").stop().animate({scrollTop:i},350),lastPos=i),"divider"==e.action&&(lastPos=-1e3)}}nextAction<playingSequence.length?requestAnimationFrame(checkActions):cancel({keepAnimations:!0})}}